<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>AAC Members CSV Tool</title>
  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- PapaParse -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.2.0/papaparse.min.js"></script>
</head>
<body class="bg-slate-100 min-h-screen flex items-center justify-center">
  <div class="max-w-2xl w-full bg-white shadow-lg rounded-xl p-8 space-y-6">
    <header class="space-y-2">
      <h1 class="text-2xl font-semibold text-slate-900">AAC Members CSV Cleaner</h1>
      <p class="text-sm text-slate-600">
        Upload a CSV export, convert dates to <code>YYYY-MM-DD</code> format, and download a cleaned file.
      </p>
    </header>

    <section class="space-y-4">
      <label class="block">
        <span class="block text-sm font-medium text-slate-700 mb-2">1. Choose CSV file</span>
        <label
          for="fileInput"
          class="flex items-center justify-between px-4 py-3 border-2 border-dashed border-slate-300 rounded-lg cursor-pointer hover:border-indigo-400 hover:bg-indigo-50 transition">
          <div>
            <p class="text-sm font-medium text-slate-800">Click to browse</p>
            <p id="fileName" class="text-xs text-slate-500">No file selected</p>
          </div>
          <span class="inline-flex items-center px-3 py-1 text-xs font-medium rounded-full bg-indigo-600 text-white">
            Choose file
          </span>
        </label>
        <input id="fileInput" type="file" accept=".csv"
               class="hidden" />
      </label>

      <div class="flex items-center justify-between">
        <div class="text-xs text-slate-500">
          Columns used: CurrentMembershipStatus, JoinedDate, RegistrationDocumentNumber, FullNameNative, ToAddressAs,
          DateOfBirth, Gender, Race, Phone, ResidesWithinServiceBoundaryStr, NricAddress_PostalCode, FullAddress, SpokenLanguage.
        </div>
      </div>

      <button
        id="processBtn"
        class="w-full mt-2 inline-flex items-center justify-center px-4 py-2.5 border border-transparent text-sm font-medium rounded-lg shadow-sm text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 disabled:opacity-40 disabled:cursor-not-allowed">
        2. Process & Download CSV
      </button>

      <p id="status" class="text-xs text-slate-500 h-5"></p>
    </section>
  </div>

  <script>
    const wantedCols = [
      "CurrentMembershipStatus",
      "JoinedDate",
      "RegistrationDocumentNumber",
      "FullNameNative",
      "ToAddressAs",
      "DateOfBirth",
      "Gender",
      "Race",
      "Phone",
      "ResidesWithinServiceBoundaryStr",
      "NricAddress_PostalCode",
      "FullAddress",
      "SpokenLanguage"
    ];

    const outputHeaders = [
      "currentmembershipstatus",
      "joineddate",
      "registrationdocumentnumber",
      "fullnamenative",
      "toaddressas",
      "dateofbirth",
      "gender",
      "race",
      "phone",
      "resideswithinserviceboundarystr",
      "nricaddress_postalcode",
      "fulladdress",
      "spokenlanguage"
    ];

    const monthMap = {
      Jan: "01", Feb: "02", Mar: "03", Apr: "04",
      May: "05", Jun: "06", Jul: "07", Aug: "08",
      Sep: "09", Oct: "10", Nov: "11", Dec: "12"
    };

    function toYMD(value) {
      if (!value) return "";
      const parts = value.split("-");
      if (parts.length !== 3) return value;
      const [dd, mmm, yyyy] = parts;
      const mm = monthMap[mmm] || mmm;
      const day = dd.padStart(2, "0");
      return `${yyyy}-${mm}-${day}`;
    }

    const fileInput = document.getElementById("fileInput");
    const fileNameLabel = document.getElementById("fileName");
    const processBtn = document.getElementById("processBtn");
    const statusEl = document.getElementById("status");

    fileInput.addEventListener("change", () => {
      const file = fileInput.files[0];
      fileNameLabel.textContent = file ? file.name : "No file selected";
    });

    processBtn.addEventListener("click", () => {
      const file = fileInput.files[0];
      if (!file) {
        statusEl.textContent = "Please choose a CSV file first.";
        return;
      }

      statusEl.textContent = "Reading and processing fileâ€¦";

      Papa.parse(file, {
        header: true,
        skipEmptyLines: true,
        complete: (results) => {
          const rows = results.data;

          const outRows = rows.map(row => {
            const obj = {};
            wantedCols.forEach((col, i) => {
              let v = row[col] || "";
              if (col === "JoinedDate" || col === "DateOfBirth") {
                v = toYMD(v);
              }
              obj[outputHeaders[i]] = v;
            });
            return obj;
          });

          const csv = Papa.unparse(outRows, { columns: outputHeaders });

          const blob = new Blob([csv], { type: "text/csv;charset=utf-8;" });
          const url = URL.createObjectURL(blob);
          const a = document.createElement("a");
          a.href = url;
          a.download = "aac_members_transformed.csv";
          document.body.appendChild(a);
          a.click();
          document.body.removeChild(a);
          URL.revokeObjectURL(url);

          statusEl.textContent = "Done! Download should start automatically.";
        },
        error: (err) => {
          statusEl.textContent = "Error parsing CSV: " + err.message;
        }
      });
    });
  </script>
</body>
</html>
